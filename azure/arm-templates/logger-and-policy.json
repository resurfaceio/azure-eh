{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "apiManagementServiceName": {
        "type": "string"
      },
      "loggerID": {
        "type": "string",
        "defaultValue": "ResurfaceLogger",
        "metadata": {
          "description": "Identifier for the Azure APIM Logger service"
        }
      },
      "eventHubsNamespaceName": {
        "type": "string",
        "defaultValue": "ResurfaceEH"
      },
      "eventHubsInstanceName": {
        "type": "string",
        "defaultValue": "ResurfaceLoggingEH"
      },
      "partitionNumber": {
        "type": "string",
        "defaultValue": "0",
        "metadata": {
          "description": "EventHubs partition"
        }
      }
    },
    "resources": [
      {
        "apiVersion": "2017-03-01",
        "type": "Microsoft.ApiManagement/service/loggers",
        "name": "[concat(parameters('apiManagementServiceName'),'/',parameters('loggerID'))]",
        "properties": {
          "loggerType": "azureEventHub",
          "description": "Resurface Logger",
          "credentials": {
            "name": "[parameters('eventHubsInstanceName')]",
            "connectionString": "[listKeys(resourceId('Microsoft.EventHub/namespaces/authorizationRules',parameters('eventHubsNamespaceName'),'RootManageSharedAccessKey'),'2017-04-01').primaryConnectionString]"
          }
        }
      },
      {
        "apiVersion": "2019-12-01",
        "type": "Microsoft.ApiManagement/service/policies",
        "name": "[concat(parameters('apiManagementServiceName'),'/policy')]",
        "properties": {
          "value": "[concat('<policies><inbound><set-variablename_x003D_\"request-string\"value_x003D_\"@{varbody_x003D_context.Request.Body?.As<string>(true);if(body!_x003D_null&&body.Length>1024){body_x003D_body.Substring(0,1024);}varheaders_x003D_context.Request.Headers.Where(h_x003D_>h.Key!_x003D_\"Authorization\"&&h.Key!_x003D_\"Ocp-Apim-Subscription-Key\").Select(h_x003D_>string.Format(\"{0}:{1}\",h.Key,String.Join(\",\",h.Value))).ToArray<string>();returnnewJObject(newJProperty(\"method\",context.Request.Method),newJProperty(\"url\",context.Request.Url.ToString()),newJProperty(\"body\",bodyisnull?string.Empty:body),newJProperty(\"headers\",headers)).ToString();}\"/></inbound><backend><forward-requestfollow-redirects_x003D_\"true\"/></backend><outbound><log-to-eventhublogger-id_x003D_\"',parameters('loggerID'),'\"partition-id_x003D_\"',parameters('partitionNumber'),'\">@{varbody_x003D_context.Response.Body?.As<string>(true);if(body!_x003D_null&&body.Length>1024){body_x003D_body.Substring(0,1024);}varheaders_x003D_context.Response.Headers.Select(h_x003D_>string.Format(\"{0}:{1}\",h.Key,String.Join(\",\",h.Value))).ToArray<string>();varresponse_x003D_newJObject(newJProperty(\"status\",context.Response.StatusCode),newJProperty(\"body\",body),newJProperty(\"headers\",headers));returnnewJObject(newJProperty(\"request\",context.Variables[\"request-string\"]),newJProperty(\"response\",response.ToString())).ToString();}</log-to-eventhub></outbound></policies>')]"
        },
        "dependsOn": ["[resourceId('Microsoft.ApiManagement/service/loggers', parameters('apiManagementServiceName'), parameters('loggerID'))]"]
      }
    ],
    "outputs": {
    }
  }
