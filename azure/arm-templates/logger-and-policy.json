{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "apiManagementServiceName": {
        "type": "string"
      },
      "loggerID": {
        "type": "string",
        "defaultValue": "ResurfaceLogger",
        "metadata": {
          "description": "Identifier for the Azure APIM Logger service"
        }
      },
      "eventHubsNamespaceName": {
        "type": "string",
        "defaultValue": "ResurfaceEH"
      },
      "eventHubsInstanceName": {
        "type": "string",
        "defaultValue": "ResurfaceLoggingEH"
      },
      "partitionNumber": {
        "type": "string",
        "defaultValue": "0",
        "metadata": {
          "description": "EventHubs partition"
        }
      }
    },
    "resources": [
      {
        "apiVersion": "2017-03-01",
        "type": "Microsoft.ApiManagement/service/loggers",
        "name": "[concat(parameters('apiManagementServiceName'),'/',parameters('loggerID'))]",
        "properties": {
          "loggerType": "azureEventHub",
          "description": "Resurface Logger",
          "credentials": {
            "name": "[parameters('eventHubsInstanceName')]",
            "connectionString": "[listKeys(resourceId('Microsoft.EventHub/namespaces/authorizationRules',parameters('eventHubsNamespaceName'),'RootManageSharedAccessKey'),'2017-04-01').primaryConnectionString]"
          }
        }
      },
      {
        "apiVersion": "2019-12-01",
        "type": "Microsoft.ApiManagement/service/policies",
        "name": "[concat(parameters('apiManagementServiceName'),'/policy')]",
        "properties": {
          "value": "[concat('_x003C_policies_x003E__x003C_inbound_x003E__x003C_set-variablename_x003D__x0022_request-string_x0022_value_x003D__x0022__x0040__x007B_varbody_x003D_context.Request.Body_x003F_.As_x003C_string_x003E_(true);if(body!_x003D_null&&body.Length_x003E_1024)_x007B_body_x003D_body.Substring(0,1024);_x007D_varheaders_x003D_context.Request.Headers.Where(h_x003D__x003E_h.Key!_x003D__x0022_Authorization_x0022_&&h.Key!_x003D__x0022_Ocp-Apim-Subscription-Key_x0022_).Select(h_x003D__x003E_string.Format(_x0022__x007B_0_x007D_:_x007B_1_x007D__x0022_,h.Key,String.Join(_x0022_,_x0022_,h.Value))).ToArray_x003C_string_x003E_();returnnewJObject(newJProperty(_x0022_method_x0022_,context.Request.Method),newJProperty(_x0022_url_x0022_,context.Request.Url.ToString()),newJProperty(_x0022_body_x0022_,bodyisnull_x003F_string.Empty:body),newJProperty(_x0022_headers_x0022_,headers)).ToString();_x007D__x0022_/_x003E__x003C_/inbound_x003E__x003C_backend_x003E__x003C_forward-requestfollow-redirects_x003D__x0022_true_x0022_/_x003E__x003C_/backend_x003E__x003C_outbound_x003E__x003C_log-to-eventhublogger-id_x003D__x0022_',parameters('loggerID'),'_x0022_partition-id_x003D__x0022_',parameters('partitionNumber'),'_x0022__x003E__x0040__x007B_varbody_x003D_context.Response.Body_x003F_.As_x003C_string_x003E_(true);if(body!_x003D_null&&body.Length_x003E_1024)_x007B_body_x003D_body.Substring(0,1024);_x007D_varheaders_x003D_context.Response.Headers.Select(h_x003D__x003E_string.Format(_x0022__x007B_0_x007D_:_x007B_1_x007D__x0022_,h.Key,String.Join(_x0022_,_x0022_,h.Value))).ToArray_x003C_string_x003E_();varresponse_x003D_newJObject(newJProperty(_x0022_status_x0022_,context.Response.StatusCode),newJProperty(_x0022_body_x0022_,body),newJProperty(_x0022_headers_x0022_,headers));returnnewJObject(newJProperty(_x0022_request_x0022_,context.Variables[_x0022_request-string_x0022_]),newJProperty(_x0022_response_x0022_,response.ToString())).ToString();_x007D__x003C_/log-to-eventhub_x003E__x003C_/outbound_x003E__x003C_/policies_x003E_')]"
        },
        "dependsOn": ["[resourceId('Microsoft.ApiManagement/service/loggers', parameters('apiManagementServiceName'), parameters('loggerID'))]"]
      }
    ],
    "outputs": {
    }
  }
